/*
 * File: app/controller/Shortlist.js
 *
 * This file was generated by Sencha Architect
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Sencha Touch 2.4.x library, under independent license.
 * License of Sencha Architect does not include license for Sencha Touch 2.4.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('ProDooMobileApp.controller.Shortlist', {
    extend: 'Ext.app.Controller',

    alternateClassName: [
        'Shortlist'
    ],

    statics: {
        onShortlistResumeItemClick: function(className, data) {

            if(className === 'x-button-label'){
                Shortlist.DeleteRecord(data);

            }

            else
            {
                var resumeId=G.get('hfResumeId').getValue();
                if(resumeId!="-1"){
                    var shortlistId=data.ShortlistId;
                    Shortlist.onCreateShortListedResume(resumeId, shortlistId);
                    G.Pop();
                }
                else{
                    Ext.Ajax.request({
                        url: ApiBaseUrl+'Shortlistresumes/get?shortlistid='+data.ShortlistId,
                        method: 'Get',
                        headers: { 'Content-Type': 'application/json' },
                        success: function(conn, response, options, eOpts) {

                            var result = Ext.JSON.decode(conn.responseText);
                            if (result.success) {
                                if(result.items!==null){
                                    var ResultSavedStore  = Ext.getStore('SearchResultSaved');
                                    var records = ResultSavedStore.getRange();
                                    ResultSavedStore.remove(records);
                                    ResultSavedStore.sync();
                                    G.Push('SearchResultSavedScreen');
                                }
                                else{
                                    Ext.Msg.alert('Status', 'No matched resume found!',null);
                                }
                            } else {

                            }


                        },
                        failure: function(conn, response, options, eOpts) {
                            //failure catch

                        }
                    });
                }
            }
        },

        onCreateShortListedResume: function(resumeId, shortlistId) {
            var shortListObj = new Object();
            shortListObj.ResumeId = resumeId;
            shortListObj.ShortlistId = shortlistId;

            Ext.Ajax.request({
                url: ApiBaseUrl+'ShortlistResumes/Post',
                method: 'Post',
                headers: { 'Content-Type': 'application/json' },
                params : Ext.JSON.encode(shortListObj),
                success: function(conn, response, options, eOpts) {
                    var result = Ext.JSON.decode(conn.responseText);
                    if (!result.success)
                    G.showGeneralFailure();
                },
                failure: function(conn, response, options, eOpts) {
                    //failure catch
                    G.showGeneralFailure();
                }
            });
        },

        onCreateShortlist: function(shortlistTitle, ResumeIdList, shortlistId) {
            var authStore = Ext.getStore('AuthStore');
            var authRec = authStore.getAt(0);

            var shortListObj = new Object();
            shortListObj.UserId = authRec.get('UserId');
            shortListObj.ShortlistName = shortlistTitle;
            shortListObj.ShortlistId = shortlistId?shortlistId: -1; // this method is also using to store shortlisted resume of existing shortlist
            shortListObj.ResumeIdsList = ResumeIdList;

            Ext.Ajax.request({
                url: ApiBaseUrl+'ShortLists/Post',
                method: 'Post',
                headers: { 'Content-Type': 'application/json' },
                params : Ext.JSON.encode(shortListObj),
                success: function(conn, response, options, eOpts) {
                    var result = Ext.JSON.decode(conn.responseText);
                    if (result.success)
                    {
                        if(localStorage.SubmitDirectRequest=="true")
                        {
                            G.get('hfShortlistId').setValue(result.items);
                            SaveSearch.saveSearchResume(true,shortlistTitle.replace('-shortlist', '-search'));

                        }
                        else
                        Shortlist.showShortListView();
                    }
                    else
                    G.showGeneralFailure();

                },
                failure: function(conn, response, options, eOpts) {
                    //failure catch
                    G.showGeneralFailure();
                }
            });
        },

        showShortListView: function() {
            var loggedUserId = Ext.getStore('AuthStore').getAt(0).get('UserId');
            var shortlistStore = Ext.getStore('ShortlistResumeStore');
            shortlistStore.load({
                params : { userId : loggedUserId
                }
            });
            var hf= G.get('hfResumeId'); //restore resumeID into hidden field
            var tempId=hf? hf.getValue():-1;
            G.Push('Shortlist');
            G.get('hfResumeId').setValue(tempId);;
        },

        DeleteRecord: function(data) {
            Ext.Ajax.request({
                url: ApiBaseUrl+'Shortlists/delete',
                method: 'Delete',
                params : Ext.JSON.encode(data),
                headers: { 'Content-Type': 'application/json' },
                success: function(conn, response, options, eOpts) {
                    var result = Ext.JSON.decode(conn.responseText);
                    if (result.success) {
                        Shortlist.showShortListView();
                    } else {
                        G.showGeneralFailure();
                    }

                },
                failure: function(conn, response, options, eOpts) {
                    //failure catch
                    G.showGeneralFailure();
                }
            });
        }
    },

    config: {
    }
});