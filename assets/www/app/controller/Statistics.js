/*
 * File: app/controller/Statistics.js
 *
 * This file was generated by Sencha Architect
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Sencha Touch 2.4.x library, under independent license.
 * License of Sencha Architect does not include license for Sencha Touch 2.4.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('ProDooMobileApp.controller.Statistics', {
    extend: 'Ext.app.Controller',

    alternateClassName: [
        'Statistics'
    ],

    statics: {
        GetStatistics: function() {
            Ext.Ajax.request({
                url : ApiBaseUrl+'resumes/GetResumeSummary',
                method : 'GET',
                headers: { 'Content-Type': 'application/json' },
                success : function (response) {

                    var responseDecode = Ext.decode(response.responseText);
                    if (responseDecode.success) {
                        var resume = responseDecode.items.ResumeStatistics;
                        var request = responseDecode.items.RequestStatistics;
                        if(resume!==null){

                            var store = Ext.getStore('StatisticsResume');
                            var records = store.getRange();
                            store.remove(records);
                            store.add(resume.Results);
                            store.sync();
                            var ResumeCount=G.get('ResumeCount');
                            ResumeCount.setHtml(resume.Total+' Resumes');


                            var requeststore = Ext.getStore('StatisticsRequest');
                            var requestrecords = requeststore.getRange();
                            requeststore.remove(requestrecords);
                            requeststore.add(request.Results);
                            requeststore.sync();
                            var RequestCount=G.get('RequestCount');
                            RequestCount.setHtml(request.Total+' Requests');

                            var statisticsGraphStore = Ext.getStore('StatisticsGraph');
                            store.data.items.forEach(function(item, index){
                                var model=Ext.create("ProDooMobileApp.model.StatisticsGraphModel");
                                model.data.DateCreated=item.data.DateCreated;
                                model.data.Time=item.data.DateMonth;
                                model.data.Resume=item.data.Count;
                                model.data.Request=0;
                                statisticsGraphStore.add(model);
                            });

                            requeststore.data.items.forEach(function(item, index){
                                var recIndex=statisticsGraphStore.findExact("Time", item.data.DateMonth);
                                if (recIndex > -1)
                                {
                                    var rec=statisticsGraphStore.getAt(recIndex);
                                    rec.data.Request=item.data.Count;
                                }
                                else
                                {
                                    var model=Ext.create("ProDooMobileApp.model.StatisticsGraphModel");
                                    model.data.DateCreated=item.data.DateCreated;
                                    model.data.Time=item.data.DateMonth;
                                    model.data.Request=item.data.Count;
                                    model.data.Resume=0;
                                    statisticsGraphStore.add(model);
                                }
                            });

                            statisticsGraphStore.sort('DateCreated', 'ASC');

                            statisticsGraphStore.sync();
                            Ext.ComponentQuery.query("#ResumeLabel")[0].setHtml(resume.Total +" Resume");
                            Ext.ComponentQuery.query("#RequestLabel")[0].setHtml(request.Total +" Request");

                        }
                    }
                    else{
                        G.showGeneralFailure();
                    }
                },
                failure : function (e) {
                    G.showGeneralFailure();
                }
            });
            G.Push('StatisticsView');
        }
    },

    config: {
    }
});